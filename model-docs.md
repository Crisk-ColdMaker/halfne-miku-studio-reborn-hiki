# 模型配置说明

## 背景

小初音工作室Reborn的模型系统参考了Flash版本通过元件构造的模型结构

并且增加了一系列便于开发的特性，使得通用化的模型构建成为可能

在此基础上，提供了简单接入重力物理、连接件等基本能力的封装函数

便于完成原版模型的微调、素材变更、增加装饰物等修改

## 文件结构

小初音工作室Reborn的模型文件是一个单独的js脚本

当进行导入时，它会在一个带有一定上下文（也小初音工作室Reborn即提供的封装函数）的环境中被eval

输出结果应当为一个对象，小初音工作室Reborn中称之为Config，其内容的含义会在下面进行说明

你可以在本项目的`models`目录中找到可用于导入的两个模型文件以便参考

开发阶段你可以跑起本地环境之后通过直接修改`src/defaultModel.js`并刷新页面的方式快速进行迭代

最后将 `// COPY AREA START` 到 `// COPY AREA END` 之间的部分另存为一个js文件即可进行导入

## Config

### parseControl

函数类型。用于预处理引擎传入的原始控制数据（鼠标键盘等）。

在默认初音模型中，用于将鼠标输入转换为内部的一些角度值， 以及将键盘输入转换为当前的脸、口、眼状态。

默认值为`o=>o`，也即不进行任何处理。

#### 入参

入参只有一个，对象类型，定义为`{mouseX:Number, mouseY:Number, keyInput:any[], ...prevControl}`

mouseX和mouseY为当前时间的鼠标坐标

keyInput为当前时间的转换好的键盘输入列表（也即keyMapping中按键到ID的映射完成后的键盘输入）

录制回放时也是只进行上述原始控制数据的录制。

该对象的剩余部分为上一次这个函数运行时返回的`control`对象，这一特性允许你在每帧更新之间保留一些状态。

举个例子，按键切换眼睛类型后按键不会始终按下，但是眼睛类型需要继续保持，此时只要在这个函数中始终保持之前的`eyeType`不变即可

相反的，当不按任何按键时嘴型应该切换为闭嘴，所以在这个函数中会首先将`mouth`置为1，再处理`keyInput`中关于嘴型的输入

#### 返回值

返回值为处理好的`control`对象，会在之后处理`model`部分时使用到（没错，是便于你自己后续使用的）

### model

对象类型。用于描述你的整个模型。

你的整个模型也是一个组件（component），所以下面的定义实际上就是一个组件的定义。

但是，model的根节点只支持部分属性，所以还是从第一个子组件开始自由发挥比较好。

#### id

字符串类型。这是你用来在整个模型中定位一个特定组件时需要的名称。

在后文中会多次出现路径（path）这个说法，它的含义是是从根节点出发到你目标节点的路程中，所有经过的子节点的id（但不含根节点），以`.`
连接（例：`head.tailL`）

虽然根节点的id始终不会被用上，但是为了开发方便考虑，还是建议你传入一个`'root'`

#### components

列表类型，元素的类型为组件。顾名思义，这里包含了当前组件的子组件。

由于绘制时是一层一层往上叠加的，在这个列表里越靠后的越在上层。

#### virtual

布尔类型。默认值为false。

一个virtual的组件被认为是虚拟的，它和它的子组件永远不会被绘制到舞台上，但是仍然参与模型和物理的运算。

它的主要作用是允许组件的绘制突破components的层级限制。（例：初音的双马尾需要出现在上半身的后面，而初音的脸需要出现在上半身的前面，且这两个组件都为头部的子组件。此时可以在头部利用一个虚拟组件确定马尾的位置后，再在根节点开一个真实组件定位到这个虚拟组件的相同位置进行最终绘制。）

此外，还可以用于手臂、腿等连接件的打点定位，便于后续使用提供的封装函数进行绘制。

需要注意的是，这不是用于动态展示/隐藏组件的。你应该使用resource的方式隐藏组件以提高整体性能。

#### 动态属性及其计算方式

model对象中，除了id、virtual和component这些有特殊作用的属性外，都支持传入函数实现动态计算。

小初音工作室Reborn在每一帧绘制之前，会通过不断依次调用model中每一个函数的方式，试图将整个model对象中包含的函数都转换成确定的值（也即这些函数的返回值）。

这个函数的入参定义为`(control, root, physics)`，control为parseControl的返回结果，config为当前状态下的model根节点对象，physics为物理引擎的处理结果。

当本次运算能够确定当前属性的值时，直接返回对应的值。

当本次调用还不足以确定当前属性的值时（比如依赖的另一个组件的某个属性还没有确定），返回undefined。

#### resource

字符串类型，会直接传入img的src中。建议直接使用dataURL的方式传入以避免资源加载问题。

#### width

#### height

资源的宽高，单位为像素。如果不传的话会直接使用resource的宽高。

#### resourceCenterX

#### resourceCenterY

组件中心（旋转及缩放）在资源上的位置，单位为像素。

#### x

#### y

组件中心相对于它的父组件（根组件则相对舞台左上角）的位置，单位为像素。

#### rotation

组件绕它的中心顺时针旋转的角度，单位为度（deg）。

#### scaleX

#### scaleY

组件的缩放比例。2为放大到200%，0.5为缩小到50%。

#### massX

#### massY

组件重心相对于组件中心的位置，单位为像素。

#### gravityX

#### gravityY

组件受到的重力加速度。单位请结合demo自行探索。

#### damp

组件的运动阻力。单位请结合demo自行探索。

#### 其它

其它的属性会被直接传入这个组件的style对象中，例如opacity等CSS属性都可以在这里使用。

自由发挥你的想象力吧！